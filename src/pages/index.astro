---
// Goat Milk Monitor - Production Dashboard
---

<!doctype html>
<html lang="id">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Goat Milk Monitor - Dashboard</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family:
                    system-ui,
                    -apple-system,
                    sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 20px;
                min-height: 100vh;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
            }
            h1 {
                color: white;
                text-align: center;
                margin-bottom: 30px;
                font-size: 2.5rem;
            }
            .nav-links {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }
            .nav-links a {
                background: white;
                color: #667eea;
                padding: 10px 20px;
                border-radius: 5px;
                text-decoration: none;
                font-weight: 600;
                transition: transform 0.2s;
            }
            .nav-links a:hover {
                transform: translateY(-2px);
            }
            .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            .stat-card {
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .stat-card h3 {
                font-size: 0.9rem;
                color: #666;
                margin-bottom: 10px;
            }
            .stat-card .value {
                font-size: 2rem;
                font-weight: bold;
                color: #333;
            }
            .chart-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
                gap: 20px;
                margin-bottom: 20px;
            }
            .chart-container {
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .chart-container h2 {
                margin-bottom: 15px;
                color: #333;
                font-size: 1.2rem;
            }
            .chart-wrapper {
                position: relative;
                height: 300px;
            }
            .status {
                background: white;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .status-indicator {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: #10b981;
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }
            .btn {
                background: #3b82f6;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 1rem;
            }
            .btn:hover {
                background: #2563eb;
            }
            .quality-cards {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            .quality-card {
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .quality-card h3 {
                margin-bottom: 10px;
                font-size: 1.1rem;
            }
            .progress-bar {
                width: 100%;
                height: 12px;
                background: #e5e7eb;
                border-radius: 10px;
                overflow: hidden;
                margin: 10px 0;
            }
            .progress-fill {
                height: 100%;
                transition: width 0.3s ease;
            }
            .latest-reading {
                background: white;
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 20px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .reading-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin-top: 15px;
            }
            .reading-item {
                text-align: center;
            }
            .reading-value {
                font-size: 1.5rem;
                font-weight: bold;
                margin: 5px 0;
            }
            .color-preview {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                border: 3px solid #ddd;
                margin: 10px auto;
            }
            @media (max-width: 768px) {
                .chart-grid {
                    grid-template-columns: 1fr;
                }
                h1 {
                    font-size: 1.8rem;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ü•õ Goat Milk Monitor</h1>

            <div class="nav-links">
                <a href="/debug">üîç Debug</a>
            </div>

            <div class="status">
                <div>
                    <strong>Firebase Status:</strong>
                    <span id="status-text">Connecting...</span>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div class="status-indicator" id="status-indicator"></div>
                    <button class="btn" onclick="loadData()">üîÑ Refresh</button>
                </div>
            </div>

            <div
                class="latest-reading"
                id="latest-reading"
                style="display: none;"
            >
                <h2 style="margin-bottom: 10px;">üì° Pembacaan Terakhir</h2>
                <div class="reading-grid" id="latest-reading-content"></div>
            </div>

            <div class="stats" id="stats">
                <div class="stat-card">
                    <h3>Total Pembacaan</h3>
                    <div class="value" id="total-readings">0</div>
                </div>
                <div class="stat-card">
                    <h3>Rata-rata pH</h3>
                    <div class="value" id="avg-ph" style="color: #3b82f6;">
                        0
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Rata-rata MQ135</h3>
                    <div class="value" id="avg-mq135" style="color: #10b981;">
                        0
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Kualitas Baik</h3>
                    <div
                        class="value"
                        id="good-quality"
                        style="color: #10b981;"
                    >
                        0
                    </div>
                </div>
            </div>

            <div class="quality-cards">
                <div
                    class="quality-card"
                    style="border-left: 4px solid #10b981;"
                >
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;"
                    >
                        <h3
                            style="color: #10b981; margin: 0; font-size: 1.1rem;"
                        >
                            üü¢ Kualitas Baik
                        </h3>
                        <div
                            style="background: #d1fae5; color: #065f46; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;"
                        >
                            Skor: 85
                        </div>
                    </div>
                    <div
                        style="font-size: 2.5rem; font-weight: bold; color: #10b981; margin-bottom: 10px;"
                        id="quality-good-display"
                    >
                        0
                    </div>
                    <div class="progress-bar" style="margin-bottom: 12px;">
                        <div
                            class="progress-fill"
                            id="quality-good-bar"
                            style="background: #10b981; width: 0%;"
                        >
                        </div>
                    </div>
                    <div
                        style="background: #f0fdf4; padding: 12px; border-radius: 8px; margin-top: 10px;"
                    >
                        <div
                            style="font-size: 0.85rem; font-weight: 600; color: #065f46; margin-bottom: 6px;"
                        >
                            ‚úì Kriteria (Decision Tree):
                        </div>
                        <ul
                            style="margin: 0; padding-left: 20px; font-size: 0.8rem; color: #047857; line-height: 1.6;"
                        >
                            <li>pH: 6.5 - 6.8 (optimal)</li>
                            <li>MQ135: &lt; 70 (udara segar)</li>
                            <li>Bau &amp; Rasa: Segar</li>
                            <li>Warna: Putih bersih (RGB tinggi)</li>
                        </ul>
                    </div>
                </div>
                <div
                    class="quality-card"
                    style="border-left: 4px solid #f59e0b;"
                >
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;"
                    >
                        <h3
                            style="color: #f59e0b; margin: 0; font-size: 1.1rem;"
                        >
                            üü° Kualitas Sedang
                        </h3>
                        <div
                            style="background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;"
                        >
                            Skor: 60
                        </div>
                    </div>
                    <div
                        style="font-size: 2.5rem; font-weight: bold; color: #f59e0b; margin-bottom: 10px;"
                        id="quality-medium-display"
                    >
                        0
                    </div>
                    <div class="progress-bar" style="margin-bottom: 12px;">
                        <div
                            class="progress-fill"
                            id="quality-medium-bar"
                            style="background: #f59e0b; width: 0%;"
                        >
                        </div>
                    </div>
                    <div
                        style="background: #fffbeb; padding: 12px; border-radius: 8px; margin-top: 10px;"
                    >
                        <div
                            style="font-size: 0.85rem; font-weight: 600; color: #92400e; margin-bottom: 6px;"
                        >
                            ‚ö† Kriteria (Decision Tree):
                        </div>
                        <ul
                            style="margin: 0; padding-left: 20px; font-size: 0.8rem; color: #b45309; line-height: 1.6;"
                        >
                            <li>pH: 6.2 - 6.9 (kurang optimal)</li>
                            <li>MQ135: 70 - 100 (udara kurang baik)</li>
                            <li>Warna: Putih kekuningan</li>
                            <li>Segera gunakan</li>
                        </ul>
                    </div>
                </div>
                <div
                    class="quality-card"
                    style="border-left: 4px solid #ef4444;"
                >
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;"
                    >
                        <h3
                            style="color: #ef4444; margin: 0; font-size: 1.1rem;"
                        >
                            üî¥ Kualitas Buruk
                        </h3>
                        <div
                            style="background: #fee2e2; color: #991b1b; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;"
                        >
                            Skor: 30
                        </div>
                    </div>
                    <div
                        style="font-size: 2.5rem; font-weight: bold; color: #ef4444; margin-bottom: 10px;"
                        id="quality-poor-display"
                    >
                        0
                    </div>
                    <div class="progress-bar" style="margin-bottom: 12px;">
                        <div
                            class="progress-fill"
                            id="quality-poor-bar"
                            style="background: #ef4444; width: 0%;"
                        >
                        </div>
                    </div>
                    <div
                        style="background: #fef2f2; padding: 12px; border-radius: 8px; margin-top: 10px;"
                    >
                        <div
                            style="font-size: 0.85rem; font-weight: 600; color: #991b1b; margin-bottom: 6px;"
                        >
                            ‚úó Kriteria (Decision Tree):
                        </div>
                        <ul
                            style="margin: 0; padding-left: 20px; font-size: 0.8rem; color: #dc2626; line-height: 1.6;"
                        >
                            <li>pH: &lt; 6.0 atau &gt; 7.2 (ekstrem)</li>
                            <li>MQ135: &gt; 100 (udara buruk)</li>
                            <li>Bau/Rasa: Tengik/Asam</li>
                            <li>Warna: Kekuningan - Jangan konsumsi!</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-container">
                    <h2>üìä Tren pH Level (10 Terakhir)</h2>
                    <div class="chart-wrapper">
                        <canvas id="phChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üå´Ô∏è Tren MQ135 (10 Terakhir)</h2>
                    <div class="chart-wrapper">
                        <canvas id="mq135Chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h2>üìà Distribusi Kualitas Susu</h2>
                <div class="chart-wrapper">
                    <canvas id="qualityChart"></canvas>
                </div>
            </div>

            <div class="chart-container" style="margin-top: 20px;">
                <h2>üî¨ Kombinasi pH &amp; MQ135 (15 Terakhir)</h2>
                <div class="chart-wrapper" style="height: 350px;">
                    <canvas id="combinedChart"></canvas>
                </div>
            </div>
        </div>

        <script is:inline>
            /**
             * DECISION TREE CLASSIFIER - Goat Milk Quality Monitor
             *
             * Menggunakan Decision Tree untuk mengklasifikasikan kualitas susu
             * berdasarkan 7 parameter:
             * 1. pH (6.5-6.8 optimal)
             * 2. Temperature (4-8¬∞C optimal)
             * 3. Odor/Bau (dari MQ135: <70=segar, 70-100=sedang, >100=buruk)
             * 4. Taste/Rasa (dari pH: 6.4-6.7=segar, 6.2-6.9=sedang, else=buruk)
             * 5. Fat/Lemak (default 3.8% untuk susu kambing)
             * 6. Turbidity/Kekeruhan (default 0 = jernih)
             * 7. Colour/Warna (dari RGB: 245-255=baik)
             *
             * Output: 3 kategori
             * - Baik (Skor: 85) - Layak konsumsi
             * - Sedang (Skor: 60) - Segera gunakan
             * - Buruk (Skor: 30) - Buang!
             */

            const FIREBASE_URL =
                "https://goat-milk-monitor-default-rtdb.asia-southeast1.firebasedatabase.app";

            let phChart = null;
            let mq135Chart = null;
            let qualityChart = null;
            let combinedChart = null;

            async function fetchFirebaseData() {
                try {
                    const response = await fetch(
                        `${FIREBASE_URL}/readings.json`,
                    );
                    if (!response.ok) throw new Error("Failed to fetch");
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error("Error fetching data:", error);
                    const statusText = document.getElementById("status-text");
                    const statusIndicator =
                        document.getElementById("status-indicator");
                    if (statusText)
                        statusText.textContent =
                            "Error: " +
                            (error instanceof Error
                                ? error.message
                                : "Unknown error");
                    if (statusIndicator)
                        statusIndicator.style.background = "#ef4444";
                    return null;
                }
            }

            // Decision Tree Classifier untuk Kualitas Susu
            function assessQuality(
                pH,
                mq135,
                temperature = 6,
                rgb = "245,250,252",
            ) {
                // Convert RGB string to colour average
                const rgbValues = rgb.split(",").map((v) => parseInt(v.trim()));
                const colour = Math.round(
                    (rgbValues[0] + rgbValues[1] + rgbValues[2]) / 3,
                );

                // Map MQ135 to odor (air quality sensor)
                // MQ135 < 70 = fresh (1), 70-100 = medium (0), > 100 = bad (-1)
                const odor = mq135 < 70 ? 1 : mq135 < 100 ? 0 : -1;

                // Map pH to taste
                // pH 6.4-6.7 = fresh (1), 6.2-6.9 = medium (0), else = bad (-1)
                const taste =
                    pH >= 6.4 && pH <= 6.7
                        ? 1
                        : pH >= 6.2 && pH <= 6.9
                          ? 0
                          : -1;

                // Default values for parameters not from sensors
                const fat = 3.8; // Average goat milk fat content
                const turbidity = 0; // Assume clear

                // Decision Tree Classification
                return classifyWithDecisionTree(
                    odor,
                    taste,
                    pH,
                    temperature,
                    fat,
                    turbidity,
                    colour,
                );
            }

            // Decision Tree Implementation
            function classifyWithDecisionTree(
                odor,
                taste,
                pH,
                temperature,
                fat,
                turbidity,
                colour,
            ) {
                // Root: odor
                if (odor < 0) {
                    // Bau buruk/tengik
                    if (taste < -0.5) {
                        return "Buruk";
                    } else {
                        if (pH < 6.0) {
                            return "Buruk";
                        } else {
                            if (temperature < 15) {
                                return "Sedang";
                            } else {
                                return "Buruk";
                            }
                        }
                    }
                } else {
                    // Bau normal atau segar
                    if (taste < 0.5) {
                        if (pH < 6.3) {
                            return "Sedang";
                        } else {
                            if (temperature < 10) {
                                return "Sedang";
                            } else {
                                if (turbidity < 1.5) {
                                    return "Sedang";
                                } else {
                                    return "Buruk";
                                }
                            }
                        }
                    } else {
                        // Rasa segar
                        if (pH < 6.5) {
                            if (temperature < 8) {
                                return "Sedang";
                            } else {
                                return "Sedang";
                            }
                        } else {
                            // pH >= 6.5
                            if (pH < 6.9) {
                                // pH optimal 6.5-6.9
                                if (temperature < 4) {
                                    return "Sedang";
                                } else {
                                    if (temperature < 8) {
                                        // Suhu optimal 4-8¬∞C
                                        if (fat < 3.5) {
                                            if (colour < 240) {
                                                return "Sedang";
                                            } else {
                                                return "Sedang";
                                            }
                                        } else {
                                            // Fat >= 3.5% (baik)
                                            if (turbidity < 0.5) {
                                                // Jernih
                                                if (colour < 245) {
                                                    return "Sedang";
                                                } else {
                                                    return "Baik"; // ‚úÖ KUALITAS BAIK!
                                                }
                                            } else {
                                                return "Sedang";
                                            }
                                        }
                                    } else {
                                        // Temp > 8¬∞C
                                        if (temperature < 12) {
                                            return "Sedang";
                                        } else {
                                            return "Buruk";
                                        }
                                    }
                                }
                            } else {
                                // pH > 6.9
                                if (pH < 7.2) {
                                    return "Sedang";
                                } else {
                                    return "Buruk";
                                }
                            }
                        }
                    }
                }
            }

            function processReadings(data) {
                if (!data) return [];

                const readings = Object.entries(data).map(([id, reading]) => ({
                    id,
                    ...reading,
                    dateTime: new Date(reading.timestamp),
                    quality: assessQuality(
                        reading.pH,
                        reading.mq135,
                        reading.temperature,
                        reading.rgb,
                    ),
                }));

                return readings.sort((a, b) => b.dateTime - a.dateTime);
            }

            function updateLatestReading(reading) {
                if (!reading) return;

                const container = document.getElementById("latest-reading");
                const content = document.getElementById(
                    "latest-reading-content",
                );

                if (!content) return;

                const rgb = reading.rgb
                    .split(",")
                    .map((v) => parseInt(v.trim()))
                    .join(", ");
                const qualityColor =
                    reading.quality === "Baik"
                        ? "#10b981"
                        : reading.quality === "Sedang"
                          ? "#f59e0b"
                          : "#ef4444";

                content.innerHTML = `
                <div class="reading-item">
                    <small style="color: #666;">Quality</small>
                    <div class="reading-value" style="color: ${qualityColor};">${reading.quality}</div>
                </div>
                <div class="reading-item">
                    <small style="color: #666;">pH Level</small>
                    <div class="reading-value">${reading.pH}</div>
                </div>
                <div class="reading-item">
                    <small style="color: #666;">MQ135</small>
                    <div class="reading-value">${reading.mq135}</div>
                </div>
                <div class="reading-item">
                    <small style="color: #666;">Warna</small>
                    <div class="color-preview" style="background: rgb(${rgb});"></div>
                    <small>${reading.color}</small>
                </div>
                <div class="reading-item">
                    <small style="color: #666;">Status</small>
                    <div class="reading-value" style="color: ${qualityColor}; font-size: 1.2rem; font-weight: bold;">
                        ${reading.quality === "Baik" ? "‚úì Layak Konsumsi" : reading.quality === "Sedang" ? "‚ö† Segera Gunakan" : "‚úó Tidak Layak"}
                    </div>
                </div>
                <div class="reading-item">
                    <small style="color: #666;">Waktu</small>
                    <div style="font-size: 0.9rem; margin-top: 5px;">${reading.dateTime.toLocaleString("id-ID")}</div>
                </div>
            `;
                container.style.display = "block";
            }

            function updateStats(readings) {
                if (readings.length === 0) return;

                const totalReadings = readings.length;
                const avgPH =
                    readings.reduce((sum, r) => sum + r.pH, 0) / totalReadings;
                const avgMQ135 =
                    readings.reduce((sum, r) => sum + r.mq135, 0) /
                    totalReadings;
                const goodQuality = readings.filter(
                    (r) => r.quality === "Baik",
                ).length;
                const mediumQuality = readings.filter(
                    (r) => r.quality === "Sedang",
                ).length;
                const poorQuality = readings.filter(
                    (r) => r.quality === "Buruk",
                ).length;

                document.getElementById("total-readings").textContent =
                    totalReadings;
                document.getElementById("avg-ph").textContent =
                    avgPH.toFixed(2);
                document.getElementById("avg-mq135").textContent =
                    Math.round(avgMQ135);
                document.getElementById("good-quality").textContent =
                    goodQuality;

                document.getElementById("quality-good-display").textContent =
                    goodQuality;
                document.getElementById("quality-medium-display").textContent =
                    mediumQuality;
                document.getElementById("quality-poor-display").textContent =
                    poorQuality;

                const qualityGoodBarEl =
                    document.getElementById("quality-good-bar");
                const qualityMediumBarEl =
                    document.getElementById("quality-medium-bar");
                const qualityPoorBarEl =
                    document.getElementById("quality-poor-bar");

                if (totalReadings > 0) {
                    if (qualityGoodBarEl)
                        qualityGoodBarEl.style.width = `${(goodQuality / totalReadings) * 100}%`;
                    if (qualityMediumBarEl)
                        qualityMediumBarEl.style.width = `${(mediumQuality / totalReadings) * 100}%`;
                    if (qualityPoorBarEl)
                        qualityPoorBarEl.style.width = `${(poorQuality / totalReadings) * 100}%`;
                }
            }

            function createPHChart(readings) {
                const limitedReadings = readings.slice(0, 10).reverse();
                const labels = limitedReadings.map((r) =>
                    r.dateTime.toLocaleTimeString("id-ID", {
                        hour: "2-digit",
                        minute: "2-digit",
                    }),
                );
                const data = limitedReadings.map((r) => r.pH);

                if (phChart) phChart.destroy();

                const ctx = document.getElementById("phChart");
                if (!ctx) return;

                phChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "pH Level",
                                data: data,
                                borderColor: "rgb(59, 130, 246)",
                                backgroundColor: "rgba(59, 130, 246, 0.1)",
                                tension: 0.4,
                                fill: true,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                            },
                        },
                    },
                });
            }

            function createMQ135Chart(readings) {
                const limitedReadings = readings.slice(0, 10).reverse();
                const labels = limitedReadings.map((r) =>
                    r.dateTime.toLocaleTimeString("id-ID", {
                        hour: "2-digit",
                        minute: "2-digit",
                    }),
                );
                const data = limitedReadings.map((r) => r.mq135);

                if (mq135Chart) mq135Chart.destroy();

                const ctx = document.getElementById("mq135Chart");
                if (!ctx) return;

                mq135Chart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "MQ135 (Air Quality)",
                                data: data,
                                borderColor: "rgb(16, 185, 129)",
                                backgroundColor: "rgba(16, 185, 129, 0.1)",
                                tension: 0.4,
                                fill: true,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                            },
                        },
                    },
                });
            }

            function createQualityChart(readings) {
                const goodQuality = readings.filter(
                    (r) => r.quality === "Baik",
                ).length;
                const mediumQuality = readings.filter(
                    (r) => r.quality === "Sedang",
                ).length;
                const poorQuality = readings.filter(
                    (r) => r.quality === "Buruk",
                ).length;

                if (qualityChart) qualityChart.destroy();

                const ctx = document.getElementById("qualityChart");
                if (!ctx) return;

                qualityChart = new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: [
                            "Kualitas Baik",
                            "Kualitas Sedang",
                            "Kualitas Buruk",
                        ],
                        datasets: [
                            {
                                data: [goodQuality, mediumQuality, poorQuality],
                                backgroundColor: [
                                    "rgba(16, 185, 129, 0.8)",
                                    "rgba(245, 158, 11, 0.8)",
                                    "rgba(239, 68, 68, 0.8)",
                                ],
                                borderWidth: 2,
                                borderColor: "#fff",
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: "bottom",
                            },
                        },
                    },
                });
            }

            function createCombinedChart(readings) {
                const limitedReadings = readings.slice(0, 15).reverse();
                const labels = limitedReadings.map((r) =>
                    r.dateTime.toLocaleTimeString("id-ID", {
                        hour: "2-digit",
                        minute: "2-digit",
                    }),
                );
                const pHData = limitedReadings.map((r) => r.pH);
                const mq135Data = limitedReadings.map((r) => r.mq135);

                if (combinedChart) combinedChart.destroy();

                const ctx = document.getElementById("combinedChart");
                if (!ctx) return;

                combinedChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "pH Level",
                                data: pHData,
                                borderColor: "rgb(59, 130, 246)",
                                backgroundColor: "rgba(59, 130, 246, 0.1)",
                                yAxisID: "y",
                            },
                            {
                                label: "MQ135",
                                data: mq135Data,
                                borderColor: "rgb(245, 158, 11)",
                                backgroundColor: "rgba(245, 158, 11, 0.1)",
                                yAxisID: "y1",
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: "index",
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: "linear",
                                display: true,
                                position: "left",
                                title: {
                                    display: true,
                                    text: "pH Level",
                                },
                            },
                            y1: {
                                type: "linear",
                                display: true,
                                position: "right",
                                title: {
                                    display: true,
                                    text: "MQ135 (PPM)",
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                            },
                        },
                    },
                });
            }

            async function loadData() {
                console.log("Loading data from Firebase...");
                const statusText = document.getElementById("status-text");
                const statusIndicator =
                    document.getElementById("status-indicator");

                if (statusText) statusText.textContent = "Loading...";
                if (statusIndicator)
                    statusIndicator.style.background = "#f59e0b";

                const data = await fetchFirebaseData();

                if (!data) {
                    console.error("No data received");
                    return;
                }

                console.log("Raw data:", data);
                const readings = processReadings(data);
                console.log("Processed readings:", readings);

                if (readings.length === 0) {
                    if (statusText)
                        statusText.textContent = "No data in Firebase";
                    if (statusIndicator)
                        statusIndicator.style.background = "#ef4444";
                    return;
                }

                if (statusText)
                    statusText.textContent = `Connected - ${readings.length} readings`;
                if (statusIndicator)
                    statusIndicator.style.background = "#10b981";

                updateLatestReading(readings[0]);
                updateStats(readings);
                createPHChart(readings);
                createMQ135Chart(readings);
                createQualityChart(readings);
                createCombinedChart(readings);

                console.log("All charts created successfully!");
            }

            window.addEventListener("load", () => {
                console.log("Page loaded, fetching data...");
                loadData();
            });

            // Auto refresh every 30 seconds
            setInterval(() => {
                console.log("Auto refresh... (every 30 seconds)");
                loadData();
            }, 30000);
        </script>
    </body>
</html>
