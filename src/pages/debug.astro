---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Debug - Firebase Data">
	<div class="min-h-screen bg-gray-50 py-8">
		<div class="max-w-4xl mx-auto px-4">
			<h1 class="text-3xl font-bold text-gray-900 mb-6">üîç Firebase Debug Page</h1>

			<div class="bg-white rounded-lg shadow-md p-6 mb-6">
				<h2 class="text-xl font-semibold mb-4">Connection Status</h2>
				<div id="connection-status" class="text-lg">
					<span class="text-yellow-600">‚è≥ Checking connection...</span>
				</div>
			</div>

			<div class="bg-white rounded-lg shadow-md p-6 mb-6">
				<h2 class="text-xl font-semibold mb-4">Firebase Data</h2>
				<div id="firebase-data" class="bg-gray-100 p-4 rounded overflow-auto max-h-96">
					<pre class="text-sm">Loading...</pre>
				</div>
			</div>

			<div class="bg-white rounded-lg shadow-md p-6 mb-6">
				<h2 class="text-xl font-semibold mb-4">Processed Readings</h2>
				<div id="processed-readings" class="bg-gray-100 p-4 rounded overflow-auto max-h-96">
					<pre class="text-sm">Loading...</pre>
				</div>
			</div>

			<div class="bg-white rounded-lg shadow-md p-6 mb-6">
				<h2 class="text-xl font-semibold mb-4">Dashboard Stats</h2>
				<div id="dashboard-stats" class="bg-gray-100 p-4 rounded overflow-auto">
					<pre class="text-sm">Loading...</pre>
				</div>
			</div>

			<div class="bg-white rounded-lg shadow-md p-6 mb-6">
				<h2 class="text-xl font-semibold mb-4">Console Logs</h2>
				<div id="console-logs" class="bg-gray-900 text-green-400 p-4 rounded overflow-auto max-h-64 font-mono text-xs">
					<div>Initializing...</div>
				</div>
			</div>

			<div class="flex gap-4">
				<button id="refresh-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
					üîÑ Refresh Data
				</button>
				<a href="/" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors inline-block">
					‚Üê Back to Dashboard
				</a>
			</div>
		</div>
	</div>
</Layout>

<script>
	import { database, getFirebaseData } from '../lib/firebase';
	import { fetchReadings, fetchDashboardStats, listenToReadings } from '../lib/fetchData';

	// Console logger
	const consoleDiv = document.getElementById('console-logs');
	function log(message: string, type: 'info' | 'error' | 'success' = 'info') {
		if (consoleDiv) {
			const colors = {
				info: 'text-green-400',
				error: 'text-red-400',
				success: 'text-blue-400'
			};
			const timestamp = new Date().toLocaleTimeString('id-ID');
			const logEntry = document.createElement('div');
			logEntry.className = colors[type];
			logEntry.textContent = `[${timestamp}] ${message}`;
			consoleDiv.appendChild(logEntry);
			consoleDiv.scrollTop = consoleDiv.scrollHeight;
		}
		console.log(message);
	}

	async function loadData() {
		log('üöÄ Starting data fetch...', 'info');

		// Check connection
		const statusDiv = document.getElementById('connection-status');
		if (database) {
			if (statusDiv) {
				statusDiv.innerHTML = '<span class="text-green-600">‚úÖ Connected to Firebase</span>';
			}
			log('‚úÖ Firebase connection established', 'success');
		} else {
			if (statusDiv) {
				statusDiv.innerHTML = '<span class="text-red-600">‚ùå Not connected to Firebase</span>';
			}
			log('‚ùå Firebase connection failed', 'error');
			return;
		}

		try {
			// Fetch raw Firebase data
			log('üì° Fetching raw Firebase data...', 'info');
			const rawData = await getFirebaseData('readings');
			const firebaseDataDiv = document.getElementById('firebase-data');

			if (firebaseDataDiv) {
				if (rawData) {
					const dataCount = Object.keys(rawData).length;
					log(`‚úÖ Raw data fetched: ${dataCount} readings`, 'success');
					firebaseDataDiv.innerHTML = `<pre class="text-sm">${JSON.stringify(rawData, null, 2)}</pre>`;
				} else {
					log('‚ö†Ô∏è No data found in Firebase', 'error');
					firebaseDataDiv.innerHTML = '<pre class="text-sm text-red-600">No data found in Firebase.\n\nPlease add data to: readings/</pre>';
				}
			}

			// Fetch processed readings
			log('üîÑ Processing readings...', 'info');
			const readings = await fetchReadings();
			const processedDiv = document.getElementById('processed-readings');

			if (processedDiv) {
				if (readings.length > 0) {
					log(`‚úÖ Processed ${readings.length} readings`, 'success');
					processedDiv.innerHTML = `<pre class="text-sm">${JSON.stringify(readings, null, 2)}</pre>`;
				} else {
					log('‚ö†Ô∏è No processed readings available', 'error');
					processedDiv.innerHTML = '<pre class="text-sm text-yellow-600">No readings processed.\n\nRaw data exists but may have issues.</pre>';
				}
			}

			// Fetch dashboard stats
			log('üìä Calculating dashboard stats...', 'info');
			const stats = await fetchDashboardStats();
			const statsDiv = document.getElementById('dashboard-stats');

			if (statsDiv) {
				log(`‚úÖ Stats calculated: ${stats.totalReadings} total readings`, 'success');
				log(`   - Good: ${stats.goodQuality}, Medium: ${stats.mediumQuality}, Poor: ${stats.poorQuality}`, 'success');
				statsDiv.innerHTML = `<pre class="text-sm">${JSON.stringify(stats, null, 2)}</pre>`;
			}

			log('‚ú® All data loaded successfully!', 'success');

		} catch (error) {
			log(`‚ùå Error loading data: ${error}`, 'error');
			console.error('Error:', error);
		}
	}

	// Setup real-time listener
	log('üëÇ Setting up real-time listener...', 'info');
	const unsubscribe = listenToReadings((readings) => {
		log(`üîî Real-time update: ${readings.length} readings`, 'info');
		const processedDiv = document.getElementById('processed-readings');
		if (processedDiv && readings.length > 0) {
			processedDiv.innerHTML = `<pre class="text-sm">${JSON.stringify(readings, null, 2)}</pre>`;
		}
	});

	// Load data on page load
	document.addEventListener('DOMContentLoaded', () => {
		log('üìÑ Page loaded, starting initial data fetch...', 'info');
		loadData();
	});

	// Refresh button
	const refreshBtn = document.getElementById('refresh-btn');
	if (refreshBtn) {
		refreshBtn.addEventListener('click', () => {
			log('üîÑ Manual refresh triggered', 'info');
			loadData();
		});
	}

	// Cleanup on unload
	window.addEventListener('beforeunload', () => {
		if (unsubscribe) {
			unsubscribe();
			log('üßπ Cleaned up listeners', 'info');
		}
	});
</script>

<style>
	pre {
		white-space: pre-wrap;
		word-wrap: break-word;
	}
</style>
